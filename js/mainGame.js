const gameData = {
    "1": {
        "text": "Apa yang kamu bakal lakuin kalau pasangan nggak bales chat berjam-jam?",
        "image": "smaller_images/snackies.png",
        "choices": {
            "Ngechat buat nanya dia lagi ngapain": [2, ["Clingy"]],
            "Biarin aja, nanti juga bales": [2, ["Cuek"]],
            'Ngechat "kamu marah yaa sama aku?"': [2, ["Overthinking"]],
            "Ngechat buat update hari kamu": [2, ["Bucin"]],
            "Lupa kalau pernah ngechat": [2, ["Mandiri"]]
        }
    },
    "2": {
        "text": "Apa date yang paling ideal buat kamu?",
        "image": "smaller_images/snackies.png",
        "choices": {
            "Hangout di rumah, nonton, makan": [3, ["Cuek"]],
            "Jalan-jalan ke tempat baru": [3, ["Overthinking"]],
            "Makan malem romantis sambil deep talk": [3, ["Bucin"]],
            "Yang simpel aja. Ke mall, makan, dsb.": [3, ["Mandiri"]],
            "Apapun yang bikin pasangan bahagia": [3, ["Clingy"]]
        }
    },
    "3": {
        "text": "Apa yang kamu biasanya lakukan kalau berantem sama pasangan?",
        "image": "smaller_images/snackies.png",
        "choices": {
            "Kirim chat panjang lebar tentang perasaan aku": [4, ["Overthinking"]],
            "Biarin dulu, kasih dia waktu dan ruang": [4, ["Mandiri"]],
            "Ajak aktivitas seru biar ketegangan ilang": [4, ["Bucin"]],
            "Berusaha ajak ngomong pelan-pelan": [4, ["Cuek"]],
            "Langsung minta maaf, padahal bukan salah aku": [4, ["Clingy"]]
        }
    },
    "4": {
        "text": "Apa love language yang kamu paling suka?",
        "image": "smaller_images/snackies.png",
        "choices": {
            "Pakai kata-kata (Words of affirmation)": [5, ["Overthinking"]],
            "Menghabiskan waktu bareng (quality time)": [5, ["Bucin"]],
            "Pegangan tangan (physical thouch)": [5, ["Clingy"]],
            "Ngebantuin pasangan (act of service)": [5, ["Mandiri"]],
            "Dikasih kado sama pasangan (Receiving Gifts)": [5, ["Clingy"]]
        }
    },
    "5": {
        "text": "Cara favoritmu menunjukkan cinta?",
        "image": "smaller_images/snackies.png",
        "choices": {
            "Pujian-pujian dan kirim chat manis": [6, ["Bucin"]],
            "Selalu ada saat mereka butuh": [6, ["Cuek"]],
            "Rencanain jalan spontan bareng pasangan": [6, ["Clingy"]],
            "Bantu menyelesaikan masalah mereka": [6, ["Mandiri"]],
            'Selalu iseng nanya "kamu sayang aku ngga?"': [6, ["Overthinking"]]
        }
    },
    "6": {
        "text": 'Seberapa sering kamu bilang "I love you" dalam hubungan?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Setiap hari, setiap jam": [7, ["Clingy"]],
            "Waktu-waktu spesial aja (valentines day, ultah, dsb)": [7, ["Mandiri"]],
            "Kalau momennya pas": [7, ["Bucin"]],
            "Jarang, tapi aku nunjukkin dengan cara lain": [7, ["Cuek"]],
            "Kalau dia mulai menjauh": [7, ["Overthinking"]]
        }
    },
    "7": {
        "text": 'Kalau pasanganmu lupa ulang tahunmu, apa reaksimu?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Marah, nangis, mikir mereka ga peduli": [8, ["Overthinking"]],
            "Kesel diem-diem tapi nggak ngomong apa apa": [8, ["Clingy"]],
            "Ketawa aja, nggak masalah kok": [8, ["Cuek"]],
            "Langsung ghosting seminggu": [8, ["Mandiri"]],
            "Ngomel tapi langsung rayain sama pasangan": [8, ["Bucin"]]
        }
    },
    "8": {
        "text": 'Pasangan yang ideal menurutmu adalah pasangan yang...',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Cocok dengan energiku suka eksplor ke tempat/pengalaman baru": [9, ["Bucin"]],
            "Yang ngasih perhatian penuh": [9, ["Clingy"]],
            "Yang menghormati kebebasan/ruang personal aku": [9, ["Mandiri"]],
            "Yang stabil dan bisa diandalkan": [9, ["Cuek"]],
            "Yang sering kasih afirmasi": [9, ["Overthinking"]]
        }
    },
    "9": {
        "text": 'Apa pandangan kamu tentang PDA? Atau bucin di tempat umum?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Suka banget!!! pegangan tangan, pelukan, semuanya": [10, ["Clingy"]],
            "Ya, sekali-sekali gapapa deh": [10, ["Cuek"]],
            "Tergantung suasana": [10, ["Overthinking"]],
            "Nggak suka sama sekali": [10, ["Mandiri"]],
            "Kalau dia suka, aku suka": [10, ["Bucin"]]
        }
    },
    "10": {
        "text": 'Apa prioritasmu dalam hubungan?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Yang bisa nyambung secara emosional, dan deep talk": [11, ["Bucin"]],
            "Yang bisa punya pengalaman seru dan petualangan bareng": [11, ["Overthinking"]],
            "Yang menghormati ruang personal aku": [11, ["Mandiri"]],
            "Yang konsisten, nyaman dan tenang": [11, ["Cuek"]],
            "Yang kasih sayang dan perhatian terus-menerus": [11, ["Clingy"]]
        }
    },
    "11": {
        "text": 'Kalau pasanganmu lupa muji gaya atau potongan rambut baru kamu, apa yang kamu lakukan?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Tersinggung, tapi kasih kode sampai sadar": [12, ["Overthinking"]],
            "Ketawa aja, toh coma rambut": [12, ["Cuek"]],
            'Langsung bilang "eh, nggak keliatan ya rambut aku baru?"': [12, ["Clingy"]],
            "Diam dan pura-pura nggak peduli, tapi agak kesal": [12, ["Mandiri"]],
            "Bikin bercandaan besar soal itu, tapi tetap sayang": [12, ["Bucin"]]
        }
    },
    "12": {
        "text": 'Gimana cara kamu respon pasangan yang lagi bad mood',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Peluk sampai tenang": [13, ["Clingy"]],
            "Ajak aktivitas seru biar moodnya balik lagi": [13, ["Bucin"]],
            "Dengerin curhat mereka tanpa interupsi": [13, ["Cuek"]],
            "Kasih ruang sampai mereka siap bicara": [13, ["Mandiri"]],
            "Cemas dan mulai overthinking tentang apa yang salah": [13, ["Overthinking"]]
        }
    },
    "13": {
        "text": 'Kalau pasanganmu minta waktu sendiri, kamu bakal:',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Langsung overthinking, apa aku yang salah?": [14, ["Overthinking"]],
            "Yaudah gapapa, biarin aja": [14, ["Mandiri"]],
            "Mulai merencanakan kejutan untuk mereka pas balik": [14, ["Bucin"]],
            'Ketawa aja, paling mikir "akhirnya bisa maraton netflix sendirian"': [14, ["Cuek"]],
            "Susah, sedih, berat": [14, ["Clingy"]]
        }
    },
    "14": {
        "text": 'Apa yang kamu lakukan saat pasangan lupa sesuatu yang penting untukmu?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Langsung marah tapi masih maklum": [15, ["Clingy"]],
            'Berpikir keras, "apa mereka nggak peduli?"': [15, ["Overthinking"]],
            "Ingetin lagi dengan santai": [15, ["Cuek"]],
            "Biarin berlalu, nggak terlalu penting": [15, ["Mandiri"]],
            "Bikin bercandaan soal itu, tapi berharap mereka ingat": [15, ["Bucin"]]
        }
    },
    "15": {
        "text": 'Kalau pasanganmu tiba-tiba ngajak pergi jauh tanpa rencana, kamu:',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Semangat banget! ayok lah!": [16, ["Bucin"]],
            "Bertanya-tanya apakah ini ide yang baik": [16, ["Overthinking"]],
            'Bilang, "hmm.. kayaknya mendingan di rumah"': [16, ["Cuek"]],
            'Langsung post di instagram story "couple goalsss"': [16, ["Clingy"]],
            "Hmm.. kayaknya enakan pergi sendiri": [16, ["Mandiri"]]
        }
    },
    "16": {
        "text": 'Apa respon kamu kalau pasangan beli hadiah mahal buat kamu?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "OMG! Makasih! Aaa gaperlu repot-repot": [17, ["Bucin"]],
            "Makasih yaa! Tapi kenapa boros bangett?": [17, ["Mandiri"]],
            "Langsung merasa harus balas dengan hadiah yang setara": [17, ["Overthinking"]],
            "Asik, makasih ya~": [17, ["Cuek"]],
            "Seneng banget langsung update status": [17, ["Clingy"]]
        }
    },
    "17": {
        "text": 'Apa pendapatmu soal pasangan yang sering minta validasi?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Suka-suka aja. Aku suka kasih perhatian ekstra, nggak masalah": [18, ["Clingy"]],
            "Capek sih kalau keseringan": [18, ["Mandiri"]],
            "Aku juga sering minta, paham banget lah": [18, ["Overthinking"]],
            "Aku lebih suka hubungan yang santai tanpa banyak tuntutan": [18, ["Cuek"]],
            "Aku jadikan kesempatan buat bikin mereka senyum": [18, ["Bucin"]]
        }
    },
    "18": {
        "text": 'Saat pasanganmu sibuk banget, kamu...',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Kirim pesan manis supaya mereka tahu aku dukung": [19, ["Bucin"]],
            "Nunggu dengan sabar, mereka bakal kembali kalau ada waktu": [19, ["Cuek"]],
            'Mulai overthinking, "apa aku nggak cukup penting?"': [19, ["Overthinking"]],
            "Pakai waktu itu untuk fokus diriku sendiri": [19, ["Mandiri"]],
            "Bikin rencana seru untuk weekend nanti": [19, ["Clingy"]]
        }
    },
    "19": {
        "text": 'Kalau pasanganmu nggak suka pamer hubungan di media sosial, kamu:',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Sedih tapi coba mengerti": [20, ["Clingy"]],
            "Nggak masalah, aku juga nggak suka": [20, ["Mandiri"]],
            'Bertanya-tanya "apa mereka sembunyiin aku dari orang lain?"': [20, ["Overthinking"]],
            'Ketawa terus bilang "yaudah gausah drama"': [20, ["Cuek"]],
            "Tetep posting mereka secara halus": [20, ["Bucin"]],
        }
    },
    "20": {
        "text": 'Apa yang bikin hubungan terasa istimewa buatmu?',
        "image": "smaller_images/snackies.png",
        "choices": {
            "Momen kecil tapi bermakna bersama pasangan": [0, ["Bucin"]],
            "Pengalaman seru yang menciptakan kenangan baru": [0, ["Overthinking"]],
            "Hubungan bebas dari tekanan berlebihan": [0, ["Mandiri"]],
            "Stablitas dan rasa aman dalam hubungan": [0, ["Cuek"]],
            "Perasaan dihargai dan diperhatikan setiap saat": [0, ["Clingy"]],
        }
    }
};

const personalities = {
    "Clingy": 0,
    "Mandiri": 0,
    "Overthinking": 0,
    "Bucin": 0,
    "Cuek": 0
};

let remainingStates = Array.from({ length: 20 }, (_, i) => (i + 1).toString()); // Initialize remaining states

function removeCurrentState(state) {
    const index = remainingStates.indexOf(state);
    if (index > -1) {
        remainingStates.splice(index, 1);
    }
}

function getRandomNextState() {
    const randomIndex = Math.floor(Math.random() * remainingStates.length);
    return remainingStates[randomIndex];
}

let currentState = getRandomNextState();

function renderState(state) {
    const storyText = document.getElementById('story-text');
    const storyImage = document.getElementById('story-image');
    const choicesContainer = document.getElementById('choices');

    const img = new Image();
    img.src = gameData[state].image;

    img.onload = () => {
        storyImage.src = img.src;
        storyText.textContent = gameData[state].text;
        choicesContainer.innerHTML = '';

        for (const [choice, info] of Object.entries(gameData[state].choices)) {
            const button = document.createElement('button');
            button.textContent = choice;
            button.className = 'choice-button';
            removeCurrentState(state)
            button.onclick = () => changeState(info[1]); //each time you change state you update the personalities dictionary
            choicesContainer.appendChild(button);
        }
    };
}

function changeState(selectedPersonalities) {
    // console.log(personalities); 
    selectedPersonalities.forEach(personality => {
        personalities[personality]++;
    });

    currentState = getRandomNextState();

    if (remainingStates.length === 0) {
        revealMostSelectedVegetable();
    } else {
        renderState(currentState);
    }
}

function revealMostSelectedVegetable() {
    let maxCount = 0;
    let maxVeggie = '';

    for (const [vegetable, count] of Object.entries(personalities)) {
        if (count > maxCount) {
            maxCount = count;
            maxVeggie = vegetable;
        }
    }

    const storyImage = document.getElementById('story-image');
    const text = document.getElementById('story-text');
    const choicesContainer = document.getElementById('choices');
    const veggieImagePath = `smaller_images/id_cards/${maxVeggie}.png`;

    // Loading image
    const loadImg = new Image();
    loadImg.src = 'smaller_images/snackies.png';
    loadImg.className = 'responsive-image';

    // Preload the image
    const img = new Image();
    img.src = veggieImagePath;
    img.className = 'responsive-image';

    // Create the share button
    const shareButton = document.createElement('button');
    shareButton.textContent = 'Simpan foto ini dan bagikan ke teman-teman kamu supaya mereka bisa coba';
    shareButton.className = 'choice-button';

    // Hide message
    storyImage.style.display = 'none';
    choicesContainer.style.display = 'none';
    
    // Show loading message or spinner
    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'Loading your result...';
    loadingMessage.className = 'loading-message'; // Style this in CSS for visibility
    text.innerHTML = ''; // Clear previous content
    text.appendChild(loadImg);
    text.appendChild(loadingMessage);

    // Once the image is loaded, update the DOM
    img.onload = () => {
        // Hide the loading message
        loadingMessage.style.display = 'none';

        storyImage.style.display = 'none';
        choicesContainer.style.display = 'none';

        text.textContent = "Ini kamu dalam berhubungan! Coba pakai ini untuk refleksi dan menumbuhkan koneksi dengan pacar kamu.";
        text.appendChild(img);

        // Share button functionality
        shareButton.onclick = async () => {        
            try {
                // Convert the image source to a Blob
                const response = await fetch(img.src); // Fetch the image from its source
                const blob = await response.blob(); // Convert the image to a Blob
        
                // Create a ClipboardItem containing both the image and text
                const clipboardItem = new ClipboardItem({
                    "image/png": blob, // Add the image Blob
                });
        
                // Write to clipboard
                await navigator.clipboard.write([clipboardItem]);
        
                alert("Image copied to clipboard!");
            } catch (err) {
                console.error("Failed to copy image and text: ", err);
                alert("Failed to copy image and text. Please try again.");
            }
        };        

        text.appendChild(shareButton);
    };

    // Handle image loading error (optional)
    img.onerror = () => {
        loadingMessage.textContent = 'Failed to load the image. Please try again later.';
    };
}


function startGame() {
    document.querySelector('.title').style.display = 'none';
    document.getElementById('homescreen').style.display = 'none';
    document.querySelector('.start-button').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    renderState(currentState);
}

window.onload = () => {
    renderState(currentState);
}
