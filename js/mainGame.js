const gameData = {
    "1": {
        "text": "Apa yang kamu bakal lakuin kalau pasangan nggak bales chat berjam-jam?",
        "image": "smaller_images/questions/quiz-1.png",
        "choices": {
            "Ngechat buat nanya dia lagi ngapain": [1, ["Clingy"]],
            "Biarin aja, nanti juga bales": [2, ["Cuek"]],
            'Ngechat "kamu marah yaa sama aku?"': [3, ["Overthinking"]],
            "Ngechat buat update hari kamu": [4, ["Bucin"]],
            "Lupa kalau pernah ngechat": [5, ["Mandiri"]]
        }
    },
    "2": {
        "text": "Apa date yang paling ideal buat kamu?",
        "image": "smaller_images/questions/quiz-2.png",
        "choices": {
            "Hangout di rumah, nonton, makan": [1, ["Cuek"]],
            "Jalan-jalan ke tempat baru": [2, ["Overthinking"]],
            "Makan malem romantis sambil deep talk": [3, ["Bucin"]],
            "Yang simpel aja. Ke mall, makan, dsb.": [4, ["Mandiri"]],
            "Apapun yang bikin pasangan bahagia": [5, ["Clingy"]]
        }
    },
    "3": {
        "text": "Apa yang kamu biasanya lakukan kalau berantem sama pasangan?",
        "image": "smaller_images/questions/quiz-3.png",
        "choices": {
            "Kirim chat panjang lebar tentang perasaan aku": [1, ["Overthinking"]],
            "Biarin dulu, kasih dia waktu dan ruang": [2, ["Mandiri"]],
            "Ajak aktivitas seru biar ketegangan ilang": [3, ["Bucin"]],
            "Berusaha ajak ngomong pelan-pelan": [4, ["Cuek"]],
            "Langsung minta maaf, padahal bukan salah aku": [5, ["Clingy"]]
        }
    },
    "4": {
        "text": "Apa love language yang kamu paling suka?",
        "image": "smaller_images/questions/quiz-4.png",
        "choices": {
            "Pakai kata-kata (Words of affirmation)": [1, ["Overthinking"]],
            "Menghabiskan waktu bareng (quality time)": [2, ["Bucin"]],
            "Pegangan tangan (physical thouch)": [3, ["Clingy"]],
            "Ngebantuin pasangan (act of service)": [4, ["Mandiri"]],
            "Dikasih kado sama pasangan (Receiving Gifts)": [5, ["Clingy"]]
        }
    },
    "5": {
        "text": "Cara favoritmu menunjukkan cinta?",
        "image": "smaller_images/questions/quiz-5.png",
        "choices": {
            "Pujian-pujian dan kirim chat manis": [1, ["Bucin"]],
            "Selalu ada saat mereka butuh": [2, ["Cuek"]],
            "Rencanain jalan spontan bareng pasangan": [3, ["Clingy"]],
            "Bantu menyelesaikan masalah mereka": [4, ["Mandiri"]],
            'Selalu iseng nanya "kamu sayang aku ngga?"': [5, ["Overthinking"]]
        }
    },
    "6": {
        "text": 'Seberapa sering kamu bilang "I love you" dalam hubungan?',
        "image": "smaller_images/questions/quiz-6.png",
        "choices": {
            "Setiap hari, setiap jam": [1, ["Clingy"]],
            "Waktu-waktu spesial aja (valentines day, ultah, dsb)": [2, ["Mandiri"]],
            "Kalau momennya pas": [3, ["Bucin"]],
            "Jarang, tapi aku nunjukkin dengan cara lain": [4, ["Cuek"]],
            "Kalau dia mulai menjauh": [5, ["Overthinking"]]
        }
    },
    "7": {
        "text": 'Kalau pasanganmu lupa ulang tahunmu, apa reaksimu?',
        "image": "smaller_images/questions/quiz-7.png",
        "choices": {
            "Marah, nangis, mikir mereka ga peduli": [1, ["Overthinking"]],
            "Kesel diem-diem tapi nggak ngomong apa apa": [2, ["Clingy"]],
            "Ketawa aja, nggak masalah kok": [3, ["Cuek"]],
            "Langsung ghosting seminggu": [4, ["Mandiri"]],
            "Ngomel tapi langsung rayain sama pasangan": [5, ["Bucin"]]
        }
    },
    "8": {
        "text": 'Pasangan yang ideal menurutmu adalah pasangan yang...',
        "image": "smaller_images/questions/quiz-8.png",
        "choices": {
            "Cocok dengan energiku suka eksplor ke tempat/pengalaman baru": [1, ["Bucin"]],
            "Yang ngasih perhatian penuh": [2, ["Clingy"]],
            "Yang menghormati kebebasan/ruang personal aku": [3, ["Mandiri"]],
            "Yang stabil dan bisa diandalkan": [4, ["Cuek"]],
            "Yang sering kasih afirmasi": [5, ["Overthinking"]]
        }
    },
    "9": {
        "text": 'Apa pandangan kamu tentang PDA? Atau bucin di tempat umum?',
        "image": "smaller_images/questions/quiz-9.png",
        "choices": {
            "Suka banget!!! pegangan tangan, pelukan, semuanya": [1, ["Clingy"]],
            "Ya, sekali-sekali gapapa deh": [2, ["Cuek"]],
            "Tergantung suasana": [3, ["Overthinking"]],
            "Nggak suka sama sekali": [4, ["Mandiri"]],
            "Kalau dia suka, aku suka": [5, ["Bucin"]]
        }
    },
    "10": {
        "text": 'Apa prioritasmu dalam hubungan?',
        "image": "smaller_images/questions/quiz-10.png",
        "choices": {
            "Yang bisa nyambung secara emosional, dan deep talk": [1, ["Bucin"]],
            "Yang bisa punya pengalaman seru dan petualangan bareng": [2, ["Overthinking"]],
            "Yang menghormati ruang personal aku": [3, ["Mandiri"]],
            "Yang konsisten, nyaman dan tenang": [4, ["Cuek"]],
            "Yang kasih sayang dan perhatian terus-menerus": [5, ["Clingy"]]
        }
    },
    "11": {
        "text": 'Kalau pasanganmu lupa muji gaya atau potongan rambut baru kamu, apa yang kamu lakukan?',
        "image": "smaller_images/questions/quiz-11.png",
        "choices": {
            "Tersinggung, tapi kasih kode sampai sadar": [1, ["Overthinking"]],
            "Ketawa aja, toh coma rambut": [2, ["Cuek"]],
            'Langsung bilang "eh, nggak keliatan ya rambut aku baru?"': [3, ["Clingy"]],
            "Diam dan pura-pura nggak peduli, tapi agak kesal": [4, ["Mandiri"]],
            "Bikin bercandaan besar soal itu, tapi tetap sayang": [5, ["Bucin"]]
        }
    },
    "12": {
        "text": 'Gimana cara kamu respon pasangan yang lagi bad mood',
        "image": "smaller_images/questions/quiz-12.png",
        "choices": {
            "Peluk sampai tenang": [1, ["Clingy"]],
            "Ajak aktivitas seru biar moodnya balik lagi": [2, ["Bucin"]],
            "Dengerin curhat mereka tanpa interupsi": [3, ["Cuek"]],
            "Kasih ruang sampai mereka siap bicara": [4, ["Mandiri"]],
            "Cemas dan mulai overthinking tentang apa yang salah": [5, ["Overthinking"]]
        }
    },
    "13": {
        "text": 'Kalau pasanganmu minta waktu sendiri, kamu bakal:',
        "image": "smaller_images/questions/quiz-13.png",
        "choices": {
            "Langsung overthinking, apa aku yang salah?": [1, ["Overthinking"]],
            "Yaudah gapapa, biarin aja": [2, ["Mandiri"]],
            "Mulai merencanakan kejutan untuk mereka pas balik": [3, ["Bucin"]],
            'Ketawa aja, paling mikir "akhirnya bisa maraton netflix sendirian"': [4, ["Cuek"]],
            "Susah, sedih, berat": [5, ["Clingy"]]
        }
    },
    "14": {
        "text": 'Apa yang kamu lakukan saat pasangan lupa sesuatu yang penting untukmu?',
        "image": "smaller_images/questions/quiz-14.png",
        "choices": {
            "Langsung marah tapi masih maklum": [1, ["Clingy"]],
            'Berpikir keras, "apa mereka nggak peduli?"': [2, ["Overthinking"]],
            "Ingetin lagi dengan santai": [3, ["Cuek"]],
            "Biarin berlalu, nggak terlalu penting": [4, ["Mandiri"]],
            "Bikin bercandaan soal itu, tapi berharap mereka ingat": [5, ["Bucin"]]
        }
    },
    "15": {
        "text": 'Kalau pasanganmu tiba-tiba ngajak pergi jauh tanpa rencana, kamu:',
        "image": "smaller_images/questions/quiz-15.png",
        "choices": {
            "Semangat banget! ayok lah!": [1, ["Bucin"]],
            "Bertanya-tanya apakah ini ide yang baik": [2, ["Overthinking"]],
            'Bilang, "hmm.. kayaknya mendingan di rumah"': [3, ["Cuek"]],
            'Langsung post di instagram story "couple goalsss"': [4, ["Clingy"]],
            "Hmm.. kayaknya enakan pergi sendiri": [5, ["Mandiri"]]
        }
    },
    "16": {
        "text": 'Apa respon kamu kalau pasangan beli hadiah mahal buat kamu?',
        "image": "smaller_images/questions/quiz-16.png",
        "choices": {
            "OMG! Makasih! Aaa gaperlu repot-repot": [1, ["Bucin"]],
            "Makasih yaa! Tapi kenapa boros bangett?": [2, ["Mandiri"]],
            "Langsung merasa harus balas dengan hadiah yang setara": [3, ["Overthinking"]],
            "Asik, makasih ya~": [4, ["Cuek"]],
            "Seneng banget langsung update status": [5, ["Clingy"]]
        }
    },
    "17": {
        "text": 'Apa pendapatmu soal pasangan yang sering minta validasi?',
        "image": "smaller_images/questions/quiz-17.png",
        "choices": {
            "Suka-suka aja. Aku suka kasih perhatian ekstra, nggak masalah": [1, ["Clingy"]],
            "Capek sih kalau keseringan": [2, ["Mandiri"]],
            "Aku juga sering minta, paham banget lah": [3, ["Overthinking"]],
            "Aku lebih suka hubungan yang santai tanpa banyak tuntutan": [4, ["Cuek"]],
            "Aku jadikan kesempatan buat bikin mereka senyum": [5, ["Bucin"]]
        }
    },
    "18": {
        "text": 'Saat pasanganmu sibuk banget, kamu...',
        "image": "smaller_images/questions/quiz-18.png",
        "choices": {
            "Kirim pesan manis supaya mereka tahu aku dukung": [1, ["Bucin"]],
            "Nunggu dengan sabar, mereka bakal kembali kalau ada waktu": [2, ["Cuek"]],
            'Mulai overthinking, "apa aku nggak cukup penting?"': [3, ["Overthinking"]],
            "Pakai waktu itu untuk fokus diriku sendiri": [4, ["Mandiri"]],
            "Bikin rencana seru untuk weekend nanti": [5, ["Clingy"]]
        }
    },
    "19": {
        "text": 'Kalau pasanganmu nggak suka pamer hubungan di media sosial, kamu:',
        "image": "smaller_images/questions/quiz-19.png",
        "choices": {
            "Sedih tapi coba mengerti": [1, ["Clingy"]],
            "Nggak masalah, aku juga nggak suka": [2, ["Mandiri"]],
            'Bertanya-tanya "apa mereka sembunyiin aku dari orang lain?"': [3, ["Overthinking"]],
            'Ketawa terus bilang "yaudah gausah drama"': [4, ["Cuek"]],
            "Tetep posting mereka secara halus": [5, ["Bucin"]],
        }
    },
    "20": {
        "text": 'Apa yang bikin hubungan terasa istimewa buatmu?',
        "image": "smaller_images/questions/quiz-20.png",
        "choices": {
            "Momen kecil tapi bermakna bersama pasangan": [1, ["Bucin"]],
            "Pengalaman seru yang menciptakan kenangan baru": [2, ["Overthinking"]],
            "Hubungan bebas dari tekanan berlebihan": [3, ["Mandiri"]],
            "Stablitas dan rasa aman dalam hubungan": [4, ["Cuek"]],
            "Perasaan dihargai dan diperhatikan setiap saat": [5, ["Clingy"]],
        }
    }
};

const personalities = {
    "Clingy": 0,
    "Mandiri": 0,
    "Overthinking": 0,
    "Bucin": 0,
    "Cuek": 0
};

let remainingStates = Array.from({ length: 20 }, (_, i) => (i + 1).toString());
const userAnswers = {};

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const randomIndex = Math.floor(Math.random() * (i + 1));
        [array[i], array[randomIndex]] = [array[randomIndex], array[i]];
    }
    return array;
}

remainingStates = shuffleArray(remainingStates);

let currentState = 0;

function renderState(state) {
    const storyText = document.getElementById('story-text');
    const storyImage = document.getElementById('story-image');
    const choicesContainer = document.getElementById('choices');
    const navigationContainer = document.getElementById('navigation-container');

    const img = new Image();
    img.src = gameData[state].image;

    img.onload = () => {
        storyImage.src = img.src;
        storyText.textContent = gameData[state].text;
        choicesContainer.innerHTML = '';

        for (const [choice, info] of Object.entries(gameData[state].choices)) {
            const button = document.createElement("button");
            button.className = 'choice-button';
            button.textContent = choice;
            if (userAnswers.hasOwnProperty(remainingStates[currentState]) && userAnswers[(remainingStates[currentState])][0] === info[0]) {
                selectedAnswer = info;
                highlightSelectedChoice(button);
                showNextButton();
            }
            button.onclick = () => {
                selectedAnswer = info;
                highlightSelectedChoice(button);
                showNextButton();
            };
            choicesContainer.appendChild(button);
        }
        const backButton = document.getElementById("back-button");
        backButton.id = "back-button";
        backButton.className = 'back-button';
        backButton.textContent = "Sebelumnya";
        if (currentState === 0) {
            backButton.style.visibility = "hidden";
        } else {
            backButton.style.visibility = "visible";
        }
        backButton.onclick = goToPrevQuestion;
        navigationContainer.appendChild(backButton);

        const nextButton = document.getElementById("next-button");
        nextButton.id = "next-button";
        nextButton.className = 'next-button';
        nextButton.textContent = "Selanjutnya";
        if (userAnswers.hasOwnProperty(remainingStates[currentState])) {
            nextButton.style.visibility = "visible";
        } else {
            nextButton.style.visibility = "hidden";
        }
        nextButton.onclick = goToNextQuestion;


        navigationContainer.appendChild(nextButton);
    };
}

function highlightSelectedChoice(button) {
    const choiceButtons = document.getElementById("choices").children;
    for (let btn of choiceButtons) {
        btn.classList.remove("selected");
    }
    button.classList.add("selected");
}

function showNextButton() {
    const nextButton = document.getElementById('next-button');
    nextButton.style.visibility = "visible";
}

function goToNextQuestion() {
    const storyImage = document.getElementById('story-image');
    storyImage.style.display = 'block';
    if (selectedAnswer !== null) {
        changeState(selectedAnswer)
        selectedAnswer = null;
        currentState++
    }

    if (currentState === 20) {
        reviewAnswer();
    } else {
        renderState(remainingStates[currentState]);
    }
}

function goToPrevQuestion() {
    const storyImage = document.getElementById('story-image');
    storyImage.style.display = 'block';
    if (currentState > 0) {
        currentState--;
        renderState(remainingStates[currentState]);
    }
}

function changeState(selectedPersonalities) {
    userAnswers[remainingStates[currentState]] = [
        selectedPersonalities[0],
        selectedPersonalities[1]
    ];
}

function reviewAnswer() {
    const storyText = document.getElementById('story-text');
    const storyImage = document.getElementById('story-image');
    const choicesContainer = document.getElementById('choices');
    const navigationContainer = document.getElementById('navigation-container');

    storyText.innerHTML = '';
    storyImage.style.display = 'none';
    choicesContainer.innerHTML = '';
    navigationContainer.innerHTML = '';

    const outerQuestionContainer = document.createElement("div");
    outerQuestionContainer.className = 'question-container';

    const questionText = document.createElement("p");
    questionText.textContent = "Siap melanjutkan? Klik Submit jika Anda sudah yakin dengan semua pilihan Anda.";
    outerQuestionContainer.appendChild(questionText);
    choicesContainer.appendChild(outerQuestionContainer);

    for (let i = 0; i < remainingStates.length; i++) {
        const questionContainer = document.createElement("div");
        questionContainer.className = 'question-container';

        const questionText = document.createElement("p");
        questionText.textContent = gameData[remainingStates[i]].text;
        questionContainer.appendChild(questionText);

        // Display the choices and highlight the selected one
        for (const [choice, info] of Object.entries(gameData[remainingStates[i]].choices)) {
            const button = document.createElement("button");
            button.className = 'choice-button';
            button.textContent = choice;

            // Highlight selected choice
            if (userAnswers.hasOwnProperty(remainingStates[i]) && userAnswers[remainingStates[i]][0] === info[0]) {
                highlightSelectedChoice(button);
                questionContainer.appendChild(button);
            }
        }

        choicesContainer.appendChild(questionContainer);
    }


    // Back button
    const backButton = document.createElement("button");
    backButton.id = "back-button";
    backButton.className = 'back-button';
    backButton.textContent = "Sebelumnya";
    backButton.style.visibility = "visible";
    backButton.onclick = goToPrevQuestion;
    navigationContainer.appendChild(backButton);

    // Next button
    const nextButton = document.createElement("button");
    nextButton.id = "next-button";
    nextButton.className = 'next-button';
    nextButton.textContent = "Submit";
    nextButton.style.visibility = "visible";
    nextButton.onclick = revealMostSelectedVegetable;
    navigationContainer.appendChild(nextButton);
}


function revealMostSelectedVegetable() {
    let maxCount = 0;
    let maxVeggie = '';

    Object.entries(userAnswers).forEach(([key, value]) => {
        value[1].forEach(personality => {
            if (personalities.hasOwnProperty(personality)) {
                personalities[personality]++;
            }
        });
    });

    for (const [vegetable, count] of Object.entries(personalities)) {
        if (count > maxCount) {
            maxCount = count;
            maxVeggie = vegetable;
        }
    }

    const storyImage = document.getElementById('story-image');
    const text = document.getElementById('story-text');
    const choicesContainer = document.getElementById('choices');
    const navigationContainer = document.getElementById('navigation-container');
    const veggieImagePath = `smaller_images/id_cards/${maxVeggie}.png`;

    // Loading image
    const loadImg = new Image();
    loadImg.src = 'smaller_images/snackies.png';
    loadImg.className = 'responsive-image';

    // Preload the image
    const img = new Image();
    img.src = veggieImagePath;
    img.className = 'responsive-image';

    // Create the share button
    const shareButton = document.createElement('button');
    shareButton.textContent = 'Simpan foto ini dan bagikan ke teman-teman kamu supaya mereka bisa coba';
    shareButton.className = 'choice-button';

    // Hide message
    storyImage.style.display = 'none';
    choicesContainer.style.display = 'none';
    navigationContainer.style.display = 'none';

    // Show loading message or spinner
    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'Loading your result...';
    loadingMessage.className = 'loading-message'; // Style this in CSS for visibility
    text.innerHTML = ''; // Clear previous content
    text.appendChild(loadImg);
    text.appendChild(loadingMessage);

    // Once the image is loaded, update the DOM
    img.onload = () => {
        // Hide the loading message
        loadingMessage.style.display = 'none';

        storyImage.style.display = 'none';
        choicesContainer.style.display = 'none';

        text.textContent = "Ini kamu dalam berhubungan! Coba pakai ini untuk refleksi dan menumbuhkan koneksi dengan pacar kamu.";
        text.appendChild(img);

        // Share button functionality
        shareButton.onclick = async () => {
            try {
                const response = await fetch(img.src);
                const blob = await response.blob();

                const clipboardItem = new ClipboardItem({
                    "image/png": blob,
                });

                await navigator.clipboard.write([clipboardItem]);

                alert("Image copied to clipboard!");
            } catch (err) {
                console.error("Failed to copy image and text: ", err);
                alert("Failed to copy image and text. Please try again.");
            }
        };

        text.appendChild(shareButton);
    };

    img.onerror = () => {
        loadingMessage.textContent = 'Failed to load the image. Please try again later.';
    };
}


function startGame() {
    document.querySelector('.title').style.display = 'none';
    document.getElementById('homescreen').style.display = 'none';
    document.querySelector('.start-button').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    renderState(remainingStates[currentState]);
}

window.onload = () => {
    renderState(remainingStates[currentState]);
}
